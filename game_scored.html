<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Simulador IA en Salud ‚Äì Juego con Ranking</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220; --card:#121a2b; --text:#e8f0ff; --muted:#a9b8d6; --accent:#37d7c6; --warn:#ffb84d; --ok:#7CFFB2;
  }
  html,body{height:100%; margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial; background:radial-gradient(1200px 600px at 20% 0%, #0f1a30 0%, #0b1220 40%, #070c17 100%); color:var(--text);}
  .wrap{max-width:900px; margin:0 auto; padding:28px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.35); backdrop-filter: blur(6px);}
  h1{font-size:28px; margin:0 0 10px; letter-spacing:.2px}
  h2{font-size:20px; margin:16px 0 8px; color:var(--muted)}
  p{line-height:1.55; color:#d7e2fb}
  .choices{display:grid; grid-template-columns:1fr; gap:12px; margin-top:18px;}
  .btn{border:1px solid rgba(255,255,255,.1); background:#17213a; color:var(--text); padding:12px 14px; border-radius:10px; cursor:pointer; transition:.15s ease; text-align:left}
  .btn:hover{transform:translateY(-1px); border-color:var(--accent)}
  .stats{display:flex; gap:10px; margin:12px 0 18px; flex-wrap:wrap}
  .chip{background:#10182b; border:1px solid rgba(255,255,255,.06); padding:8px 10px; border-radius:999px; font-size:13px; color:#a9b8d6}
  .muted{color:#a9b8d6}
  .footer{display:flex; gap:10px; margin-top:18px; flex-wrap:wrap}
  .small{font-size:12px}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
  .titlebar{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px}
  .progress{height:6px; background:#0e1628; border-radius:999px; overflow:hidden}
  .progress > b{display:block; height:100%; background:linear-gradient(90deg, var(--accent), #7e9cff); width:0%}
  .hr{height:1px; background:rgba(255,255,255,.08); margin:18px 0}
  .note{font-size:13px; color:#a9b8d6}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  input[type=text]{background:#0f1629; border:1px solid rgba(255,255,255,.1); color:var(--text); padding:10px 12px; border-radius:10px; outline:none; width:220px}
  .linkbar{display:flex; gap:10px; margin:16px 0 4px; flex-wrap:wrap}
  .linkbar a{color:#a9c7ff; text-decoration:none; border-bottom:1px dashed rgba(169,199,255,.5)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="titlebar">
      <h1>Simulador IA en Salud ‚Äì Juego con Ranking</h1>
      <div class="stats">
        <span class="chip" id="st-surv">Supervivencia: 0</span>
        <span class="chip" id="st-cost">Costos: 0</span>
        <span class="chip" id="st-trust">Confianza: 0</span>
        <span class="chip" id="st-eq">Equidad: 0</span>
      </div>
    </div>
    <div class="linkbar">
      <a href="./leaderboard.html" target="_blank">üèÜ Ver Ranking</a>
      <a href="./qrcode.html" target="_blank">üîó Generar QR</a>
    </div>
    <div class="progress"><b id="bar"></b></div>
    <div class="card" id="card"></div>
    <div class="footer">
      <button class="btn" onclick="restart()">‚ü≤ Reiniciar</button>
      <button class="btn" onclick="toggleNotes()">üóíÔ∏è Ver/ocultar notas</button>
      <span class="note small">Tip: comparte el link/QR en Teams; los alumnos juegan y suben su score.</span>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC_JuJzL8rdr-sLlPfCR-tV86r1zJ8BuGW",
  authDomain: "game-b4bec.firebaseapp.com",
  projectId: "game-b4bec",
  storageBucket: "game-b4bec.firebasestorage.app",
  messagingSenderId: "1076550611135",
  appId: "1:1076550611135:web:a9b484f73c365d53d4960a"
};
let db=null;
try {
  const app = firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
} catch(e){
  console.warn("Firebase no inicializado (usa el juego sin ranking) ‚Üí", e);
}

const story = {
  start: "start",
  nodes: {
    start: {
      title: "Ingreso a Urgencias",
      text: `Paciente 62 a√±os llega a urgencias con dolor tor√°cico y disnea.
La IA (alerta temprana validada) calcula <b>Riesgo Alto</b> de evento card√≠aco en 60 minutos.
¬øQu√© decides?`,
      choices: [
        { label: "Confiar en la IA y activar protocolo UCI", next: "uci", effects: {survival:+1, cost:+2, trust:+1}, note:"Activaste protocolo UCI basado en IA." },
        { label: "Esperar evaluaci√≥n tradicional (m√©dico + ex√°menes)", next: "eval", effects: {cost:+1}, note:"Optaste por evaluaci√≥n cl√≠nica tradicional sin priorizar IA." },
        { label: "Pedir segunda opini√≥n de IA (modelo alternativo)", next: "second", note:"Pediste segunda opini√≥n de IA para robustecer la decisi√≥n." }
      ]
    },
    uci: {
      title: "Protocolo UCI activado",
      text: `Traslado inmediato a UCI y antiplaquetarios. A los 25 min hace un evento, pero se revierte a tiempo.
<b class="ok">Resultado: sobrevive y queda estable.</b><br><br>
La UCI est√° al <b>95% de ocupaci√≥n</b>. La IA de asignaci√≥n de camas sugiere mover a un paciente estable a intermedio para dejar cama disponible.`,
      choices: [
        { label: "Aceptar sugerencia y reasignar cama", next: "reassign", effects:{equity:+1, trust:+1}, note:"Usaste IA para reasignar camas con reglas de equidad y seguridad." },
        { label: "Rechazar y mantener camas como est√°n", next: "keep", effects:{trust:-1}, note:"Rechazaste la recomendaci√≥n de reasignaci√≥n de camas." }
      ]
    },
    eval: {
      title: "Evaluaci√≥n tradicional",
      text: `Se solicitan marcadores y ECG. Pasa 1 hora por congesti√≥n.
<b class="warn">El paciente sufre un paro antes de llegar a UCI.</b> Reanimaci√≥n exitosa, pero con complicaciones.
El jefe de guardia pregunta si integrar√°s la <b>alerta de IA</b> en el flujo cl√≠nico para pr√≥ximos casos.`,
      choices: [
        { label: "Integrar la alerta (notificaci√≥n prioritaria + checklist)", next: "integrate", effects:{trust:+1}, note:"Acordaste integrar alertas de IA al flujo con checklist y auditor√≠a." },
        { label: "Seguir caso a caso (decisi√≥n ad hoc del m√©dico)", next: "adhoc", effects:{trust:-1}, note:"Dejaste la alerta como informativa sin cambios de proceso." }
      ]
    },
    second: {
      title: "Segunda opini√≥n de IA",
      text: `El segundo modelo (independiente) tambi√©n marca <b>Riesgo Alto</b> y explica variables clave (ECG, edad, troponina, historial).`,
      choices: [
        { label: "Activar protocolo UCI", next: "uci" },
        { label: "Persistir en evaluaci√≥n tradicional", next: "eval" }
      ]
    },
    reassign: {
      title: "Reasignaci√≥n de cama",
      text: `La reasignaci√≥n sigue reglas cl√≠nicas y evita sesgos (edad/sexo/seguro).
<b class="ok">Llega otro paciente cr√≠tico y la cama disponible salva otra vida.</b>
Impacto: mejor uso de recursos y menor mortalidad en guardia.`,
      choices: [{ label: "Continuar", next: "privacy" }]
    },
    keep: {
      title: "Cama ocupada",
      text: `Se satura la UCI. Un paciente cr√≠tico espera m√°s de 90 minutos.
<b class="warn">Impacto: empeora la congesti√≥n y la experiencia del paciente.</b>`,
      choices: [{ label: "Continuar", next: "privacy" }]
    },
    integrate: {
      title: "Alerta integrada al flujo",
      text: `Se configura un protocolo: <b>alerta ‚Üí verificaci√≥n cl√≠nica ‚Üí acci√≥n</b>. Adem√°s, se medir√° precisi√≥n y tiempos.`,
      choices: [{ label: "Continuar", next: "privacy" }]
    },
    adhoc: {
      title: "Caso a caso",
      text: `Las alertas se ignoran con frecuencia y la precisi√≥n aparente cae por <b>sesgo de implementaci√≥n</b>.`,
      choices: [{ label: "Continuar", next: "privacy" }]
    },
    privacy: {
      title: "Privacidad y monitoreo",
      text: `Un comit√© plantea pol√≠ticas de <b>privacidad</b> y <b>vigilancia del modelo</b>.
Proponen registrar datos m√≠nimos, anonimizar y monitorear sesgos (por g√©nero/edad/seguro). ¬øQu√© adoptas?`,
      choices: [
        { label: "Privacidad por dise√±o + monitoreo continuo del modelo", next: "pstrong", effects:{equity:+1, trust:+1}, note:"Adoptaste privacidad por dise√±o y monitoreo de sesgos." },
        { label: "Solo cumplir m√≠nimo legal (sin monitoreo activo)", next: "pmin", effects:{trust:-1}, note:"Cumplimiento m√≠nimo; no se detectan sesgos a tiempo." }
      ]
    },
    pstrong: {
      title: "Ajuste del modelo",
      text: `Se detecta que el modelo subestima riesgo en mujeres &lt;55. Se ajusta umbral y mejora el desempe√±o.`,
      choices: [{ label: "Ver resultados", next: "results" }]
    },
    pmin: {
      title: "Auditor√≠a externa",
      text: `Mes despu√©s, auditor√≠a externa encuentra disparidades; cae la confianza institucional.`,
      choices: [{ label: "Ver resultados", next: "results" }]
    },
    results: {
      title: "Resultados del turno",
      text: "",
      choices: [
        { label: "‚ü≤ Reiniciar simulaci√≥n", next: "start", reset:true },
        { label: "üíæ Enviar puntaje al Ranking", next: "submitScore" },
        { label: "üèÜ Ver Ranking", next: "openLeaderboard" },
        { label: "Lecciones finales", next: "lessons" }
      ]
    },
    lessons: {
      title: "Lecciones clave",
      text: `<ul>
<li><b>IA + flujo cl√≠nico</b> = impacto real.</li>
<li>Gesti√≥n de <b>capacidad hospitalaria</b> con IA puede salvar vidas.</li>
<li><b>Privacidad por dise√±o</b> y auditor√≠a reducen sesgos y sostienen confianza.</li>
<li>La sostenibilidad exige equilibrar innovaci√≥n, financiamiento y misi√≥n social.</li>
</ul>`,
      choices: [{ label: "‚ü≤ Reiniciar", next: "start", reset:true }]
    }
  }
};

let state, steps;
function initState(){
  state = { survival:0, cost:0, trust:0, equity:0, notes:[] };
  steps = 0;
}
function restart(){ initState(); go(story.start); }
function toggleNotes(){
  const n = document.querySelector("#notes");
  if(!n) return;
  n.style.display = (n.style.display === "none") ? "block" : "none";
}

function go(id){
  if(id==="openLeaderboard"){ window.open("./leaderboard.html", "_blank"); return; }
  if(id==="submitScore"){ return submitScore(); }

  const node = story.nodes[id];
  steps++;
  const pct = Math.min(100, Math.round((steps-1)/8*100));
  document.querySelector("#bar").style.width = pct + "%";

  let html = `<h2>${node.title}</h2><p>${node.text}</p>`;

  if(id === "results"){
    html = `<h2>${node.title}</h2>`;
    html += `<p><b>Supervivencia:</b> ${state.survival} &nbsp; <b>Costos:</b> ${state.cost} &nbsp; <b>Confianza:</b> ${state.trust} &nbsp; <b>Equidad:</b> ${state.equity}</p>`;
    let interp = "";
    interp += (state.survival>=1) ? "‚úÖ <b>Impacto cl√≠nico positivo</b>: priorizaste decisiones oportunas.<br>" :
                                    "‚ö†Ô∏è <b>Riesgo cl√≠nico</b>: las demoras afectaron el resultado.<br>";
    interp += (state.trust>=1) ? "‚úÖ <b>Gobernanza</b>: integraste IA al flujo y generaste confianza.<br>" :
                                 "‚ö†Ô∏è <b>Adopci√≥n</b>: sin integraci√≥n, la IA pierde valor.<br>";
    interp += (state.equity>=1) ? "‚úÖ <b>Equidad</b>: medidas para reducir sesgos y priorizar por necesidad.<br>" :
                                  "‚ö†Ô∏è <b>Equidad</b>: sin monitoreo, pueden surgir disparidades.<br>";
    html += `<p>${interp}</p>`;
    if(state.notes.length){
      html += `<div id="notes" class="hr" style="display:block"></div><h2>Notas de decisiones</h2><ul id="notesList"></ul>`;
      setTimeout(()=>{
        const list = document.querySelector("#notesList");
        list.innerHTML = state.notes.map(n=>`<li class="muted">${n}</li>`).join("");
      },0);
    }
  }

  const card = document.querySelector("#card");
  card.innerHTML = html;

  const block = document.createElement("div");
  block.className = "choices";
  node.choices.forEach(ch => {
    const btn = document.createElement("button");
    btn.className = "btn";
    btn.textContent = ch.label;
    btn.onclick = () => {
      if(ch.reset){ restart(); return; }
      if(ch.effects){
        for(const k in ch.effects){ state[k] = (state[k]||0) + ch.effects[k]; }
      }
      if(ch.note) state.notes.push(ch.note);
      updateStats();
      go(ch.next);
    };
    block.appendChild(btn);
  });
  card.appendChild(block);
}

function updateStats(){
  document.querySelector("#st-surv").textContent = "Supervivencia: " + state.survival;
  document.querySelector("#st-cost").textContent  = "Costos: " + state.cost;
  document.querySelector("#st-trust").textContent = "Confianza: " + state.trust;
  document.querySelector("#st-eq").textContent    = "Equidad: " + state.equity;
}

async function submitScore(){
  const name = prompt("Ingresa tu alias (sin datos personales):");
  if(!name) return go("results");
  const score = {
    name: name.substring(0,24),
    survival: state.survival,
    trust: state.trust,
    equity: state.equity,
    cost: state.cost,
    notes: state.notes.slice(0,5),
    createdAt: new Date().toISOString()
  };
  if(!db){
    alert("Ranking offline: pega tu configuraci√≥n de Firebase en el archivo para habilitar el ranking.");
    return go("results");
  }
  try{
    await db.collection("runs").add(score);
    alert("‚úÖ Puntaje enviado. Abre el Ranking para verlo.");
  }catch(e){
    console.error(e);
    alert("No se pudo enviar el puntaje. Revisa la configuraci√≥n de Firebase.");
  }
  go("results");
}

let state, steps;
initState();
updateStats();
go(story.start);
</script>
</body>
</html>
